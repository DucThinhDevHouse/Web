<!DOCTYPE html>
<html lang="vi">

<head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Travel Buddy AI Chatbot</title>
        <style>
                body {
                        font-family: Arial, sans-serif;
                        background-color: #f4f4f9;
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 100vh;
                        margin: 0;
                }

                .chat-container {
                        width: 90%;
                        max-width: 700px;
                        background: white;
                        border-radius: 12px;
                        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                }

                .chat-history {
                        flex-grow: 1;
                        padding: 20px;
                        max-height: 60vh;
                        overflow-y: auto;
                        background-color: #e9f5ff;
                }

                .message {
                        margin-bottom: 15px;
                        display: flex;
                }

                .user-message {
                        justify-content: flex-end;
                }

                .ai-message {
                        justify-content: flex-start;
                }

                .message-content {
                        padding: 10px 15px;
                        border-radius: 20px;
                        max-width: 80%;
                        line-height: 1.5;
                        white-space: pre-wrap;
                }

                .user-message .message-content {
                        background-color: #1a73e8;
                        color: white;
                        border-bottom-right-radius: 5px;
                }

                .ai-message .message-content {
                        background-color: #f0f0f0;
                        color: #333;
                        border-bottom-left-radius: 5px;
                }

                .chat-input {
                        display: flex;
                        border-top: 1px solid #ddd;
                        padding: 15px;
                        background: #fff;
                }

                #user-input {
                        flex-grow: 1;
                        padding: 10px;
                        border: 1px solid #ddd;
                        border-radius: 20px;
                        margin-right: 10px;
                }

                #send-button {
                        background-color: #1a73e8;
                        color: white;
                        border: none;
                        padding: 10px 20px;
                        border-radius: 20px;
                        cursor: pointer;
                }
        </style>
</head>

<body>

        <div class="chat-container">
                <div class="chat-history" id="chat-history">
                        <div class="message ai-message">
                                <div class="message-content">
                                        Ch√†o b·∫°n! Tui l√† Travel Buddy AI. Tui s·∫µn l√≤ng gi√∫p b·∫°n t√¨m v√† so s√°nh kh√°ch
                                        s·∫°n, ho·∫∑c tr·∫£ l·ªùi b·∫•t c·ª© c√¢u h·ªèi du l·ªãch n√†o. B·∫°n mu·ªën t√¨m kh√°ch s·∫°n ·ªü ƒë√¢u n√®?
                                </div>
                        </div>
                </div>

                <div class="chat-input">
                        <input type="text" id="user-input"
                                placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n (v√≠ d·ª•: 'Kh√°ch s·∫°n 4 sao g·∫ßn bi·ªÉn c√≥ h·ªì b∆°i')."
                                onkeypress="handleKeyPress(event)">
                        <button id="send-button" onclick="sendMessage()">G·ª≠i</button>
                </div>
        </div>

        <script>
                // *** CH√ö √ù: CH·ªàNH S·ª¨A ƒê·ªäA CH·ªà N√ÄY KHI CH·∫†Y C·ª§C B·ªò ***
                const API_BASE_URL = 'http://localhost:3000';
                // N·∫øu b·∫°n ch·∫°y tr√™n m√°y c·ª•c b·ªô, gi·ªØ nguy√™n 'http://localhost:3000'.

                const chatHistory = document.getElementById('chat-history');

                // H√†m th√™m tin nh·∫Øn v√†o l·ªãch s·ª≠ chat
                function appendMessage(text, sender) {
                        const messageElement = document.createElement('div');
                        messageElement.classList.add('message', `${sender}-message`);
                        messageElement.innerHTML = `<div class="message-content">${text}</div>`;
                        chatHistory.appendChild(messageElement);
                        chatHistory.scrollTop = chatHistory.scrollHeight; // Cu·ªôn xu·ªëng cu·ªëi
                }

                // X·ª≠ l√Ω g·ª≠i tin nh·∫Øn khi nh·∫•n Enter
                function handleKeyPress(event) {
                        if (event.key === 'Enter') {
                                sendMessage();
                        }
                }

                // X·ª≠ l√Ω logic g·ª≠i v√† nh·∫≠n tin nh·∫Øn
                async function sendMessage() {
                        const input = document.getElementById('user-input');
                        const userText = input.value.trim();

                        if (userText === '') return;

                        // 1. Hi·ªÉn th·ªã tin nh·∫Øn ng∆∞·ªùi d√πng
                        appendMessage(userText, 'user');
                        input.value = '';

                        // 2. Chu·∫©n b·ªã g·ªçi API
                        const loadingText = "Tui ƒëang ph√¢n t√≠ch y√™u c·∫ßu c·ªßa b·∫°n ƒë√¢y... ü§î";
                        appendMessage(loadingText, 'ai');
                        const aiMessage = chatHistory.lastChild.querySelector('.message-content');

                        try {
                                // Ch√∫ng ta t·∫≠n d·ª•ng Endpoint 'natural-search' ƒë·ªÉ x·ª≠ l√Ω c√¢u h·ªèi t·ªïng qu√°t/t√¨m ki·∫øm
                                const response = await fetch(`${API_BASE_URL}/api/natural-search`, {
                                        method: 'POST',
                                        headers: { 'Content-Type': 'application/json' },
                                        body: JSON.stringify({ userQuery: userText })
                                });

                                const data = await response.json();

                                if (data.success && data.searchParams) {
                                        // C·∫¨P NH·∫¨T K·∫æT QU·∫¢ T√åM KI·∫æM
                                        const params = data.searchParams;

                                        // T·∫°o ph·∫£n h·ªìi th√¢n thi·ªán d·ª±a tr√™n tham s·ªë ph√¢n t√≠ch ƒë∆∞·ª£c
                                        let replyText = "Tuy·ªát v·ªùi! Tui ƒë√£ hi·ªÉu √Ω b·∫°n r·ªìi. ";
                                        replyText += `B·∫°n ƒëang mu·ªën t√¨m kh√°ch s·∫°n c√≥: \n`;

                                        if (params.stars) replyText += `- H·∫°ng sao: ${params.stars} sao\n`;
                                        if (params.location) replyText += `- Khu v·ª±c: ${params.location}\n`;
                                        if (params.amenity) replyText += `- Ti·ªán nghi mong mu·ªën: ${params.amenity}\n`;
                                        if (params.price_max) replyText += `- Gi√° t·ªëi ƒëa: ${params.price_max.toLocaleString('vi-VN')} VND\n`;

                                        replyText += "\nB√¢y gi·ªù tui s·∫Ω b·∫Øt ƒë·∫ßu t√¨m ki·∫øm trong c∆° s·ªü d·ªØ li·ªáu c·ªßa m√¨nh (Ph·∫ßn n√†y l√† n∆°i code web c·ªßa b·∫°n s·∫Ω ho·∫°t ƒë·ªông). Tui th·∫•y y√™u c·∫ßu n√†y r·∫•t h·ª£p l√Ω ƒë√≥!";

                                        aiMessage.innerText = replyText;

                                } else {
                                        // Tr∆∞·ªùng h·ª£p API kh√¥ng ph√¢n t√≠ch ƒë∆∞·ª£c ho·∫∑c c√≥ l·ªói kh√°c
                                        aiMessage.innerText = data.message || "·ªêi, tui ƒëang g·∫∑p tr·ª•c tr·∫∑c x√≠u. B·∫°n h·ªèi l·∫°i tui c√°ch kh√°c nha.";
                                }
                        } catch (error) {
                                // L·ªói k·∫øt n·ªëi server
                                aiMessage.innerText = `L·ªói k·∫øt n·ªëi server Backend. B·∫°n ki·ªÉm tra xem server.js ƒëang ch·∫°y ch∆∞a nh√©! (${error.message})`;
                        }
                }
        </script>
</body>

</html>